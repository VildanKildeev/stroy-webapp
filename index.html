<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Web App</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

    <style>
        /* ... (ваши существующие стили остаются без изменений) ... */

        /* Добавляем стили для мобильного управления */
        .mobile-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
            width: 100%;
            max-width: 300px;
        }

        .mobile-btn {
            padding: 15px;
            font-size: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            border-radius: 10px;
            color: white;
            cursor: pointer;
        }

        #rotate-btn {
            grid-column: 2;
            grid-row: 1;
        }

        #left-btn {
            grid-column: 1;
            grid-row: 2;
        }

        #down-btn {
            grid-column: 2;
            grid-row: 2;
        }

        #right-btn {
            grid-column: 3;
            grid-row: 2;
        }

        #hard-drop-btn {
            grid-column: 1 / span 3;
            grid-row: 1;
            margin-top: 10px;
        }

        #score-display {
            color: white;
            font-size: 20px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <!-- ... (ваши существующие HTML элементы остаются без изменений) ... -->

    <!-- Игра Тетрис -->
    <div id="game-container">
        <div id="score-display">Очки: 0</div>
        <canvas id="tetris" width="240" height="400"></canvas>
        <div class="mobile-controls">
            <button id="hard-drop-btn" class="mobile-btn">БЫСТРЫЙ СБРОС</button>
            <button id="rotate-btn" class="mobile-btn">↻ ВРАЩАТЬ</button>
            <button id="left-btn" class="mobile-btn">←</button>
            <button id="down-btn" class="mobile-btn">↓</button>
            <button id="right-btn" class="mobile-btn">→</button>
        </div>
        <button id="back-button" onclick="exitTetris()">Назад</button>
    </div>

    <script>
        // ... (ваши существующие функции остаются без изменений до initTetris) ...

        // === ИСПРАВЛЕННЫЙ ТЕТРИС ===
        let gameInterval;
        let score = 0;

        function initTetris() {
            // Сброс счета
            score = 0;
            document.getElementById('score-display').textContent = "Очки: 0";
            
            const canvas = document.getElementById('tetris');
            const ctx = canvas.getContext('2d');
            const BLOCK_SIZE = 20;
            const COLS = 10;
            const ROWS = 20;
            
            // Очистка доски
            let board = Array(ROWS).fill().map(() => Array(COLS).fill(0));
            let piece = null;

            // ПРАВИЛЬНЫЕ фигуры
            const PIECES = [
                [[1, 1, 1, 1]],                               // I
                [[1, 1], [1, 1]],                             // O
                [[0, 1, 0], [1, 1, 1]],                       // T
                [[0, 1, 1], [1, 1, 0]],                       // S
                [[1, 1, 0], [0, 1, 1]],                       // Z
                [[1, 0, 0], [1, 1, 1]],                       // J
                [[0, 0, 1], [1, 1, 1]]                        // L
            ];

            // Цвета для фигур
            const COLORS = [
                '#00FFFF', // I - голубой
                '#FFFF00', // O - желтый
                '#800080', // T - фиолетовый
                '#00FF00', // S - зеленый
                '#FF0000', // Z - красный
                '#0000FF', // J - синий
                '#FFA500'  // L - оранжевый
            ];

            function newPiece() {
                const type = Math.floor(Math.random() * PIECES.length);
                return {
                    matrix: PIECES[type],
                    pos: { x: Math.floor(COLS / 2) - 1, y: 0 },
                    color: COLORS[type]
                };
            }

            function collide() {
                for (let y = 0; y < piece.matrix.length; y++) {
                    for (let x = 0; x < piece.matrix[y].length; x++) {
                        if (piece.matrix[y][x] && (
                            board[y + piece.pos.y] === undefined ||
                            board[y + piece.pos.y][x + piece.pos.x] === undefined ||
                            board[y + piece.pos.y][x + piece.pos.x] !== 0
                        )) {
                            return true;
                        }
                    }
                }
                return false;
            }

            function merge() {
                piece.matrix.forEach((row, y) => {
                    row.forEach((value, x) => {
                        if (value) {
                            board[y + piece.pos.y][x + piece.pos.x] = piece.color;
                        }
                    });
                });
            }

            function rotate() {
                const N = piece.matrix.length;
                const M = piece.matrix[0].length;
                let rotated = Array(M).fill().map(() => Array(N).fill(0));
                
                for (let i = 0; i < N; i++) {
                    for (let j = 0; j < M; j++) {
                        rotated[j][N-1-i] = piece.matrix[i][j];
                    }
                }
                
                const prevMatrix = piece.matrix;
                piece.matrix = rotated;
                if (collide()) {
                    piece.matrix = prevMatrix;
                }
            }

            function clearLines() {
                let linesCleared = 0;
                
                for (let y = ROWS - 1; y >= 0; y--) {
                    if (board[y].every(cell => cell !== 0)) {
                        board.splice(y, 1);
                        board.unshift(Array(COLS).fill(0));
                        linesCleared++;
                        y++; // Проверить ту же позицию снова
                    }
                }
                
                // Добавление очков
                if (linesCleared > 0) {
                    score += [0, 100, 300, 500, 800][linesCleared];
                    document.getElementById('score-display').textContent = "Очки: " + score;
                }
            }

            function drop() {
                piece.pos.y++;
                if (collide()) {
                    piece.pos.y--;
                    merge();
                    clearLines();
                    piece = newPiece();
                    if (collide()) {
                        clearInterval(gameInterval);
                        setTimeout(() => {
                            alert("Игра окончена! Ваш счет: " + score);
                            exitTetris();
                        }, 100);
                    }
                }
                draw();
            }

            function move(dir) {
                piece.pos.x += dir;
                if (collide()) piece.pos.x -= dir;
                draw();
            }

            function hardDrop() {
                while (!collide()) {
                    piece.pos.y++;
                }
                piece.pos.y--;
                drop();
            }

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Рисуем границы
                ctx.strokeStyle = '#555';
                ctx.lineWidth = 2;
                ctx.strokeRect(0, 0, COLS * BLOCK_SIZE, ROWS * BLOCK_SIZE);
                
                // Рисуем доску
                board.forEach((row, y) => {
                    row.forEach((value, x) => {
                        if (value) {
                            ctx.fillStyle = value;
                            ctx.fillRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
                            
                            ctx.strokeStyle = '#000';
                            ctx.lineWidth = 1;
                            ctx.strokeRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
                        }
                    });
                });
                
                // Рисуем текущую фигуру
                if (piece) {
                    piece.matrix.forEach((row, y) => {
                        row.forEach((value, x) => {
                            if (value) {
                                ctx.fillStyle = piece.color;
                                ctx.fillRect(
                                    (piece.pos.x + x) * BLOCK_SIZE,
                                    (piece.pos.y + y) * BLOCK_SIZE,
                                    BLOCK_SIZE, BLOCK_SIZE
                                );
                                
                                ctx.strokeStyle = '#000';
                                ctx.lineWidth = 1;
                                ctx.strokeRect(
                                    (piece.pos.x + x) * BLOCK_SIZE,
                                    (piece.pos.y + y) * BLOCK_SIZE,
                                    BLOCK_SIZE, BLOCK_SIZE
                                );
                            }
                        });
                    });
                }
            }

            // Инициализация игры
            piece = newPiece();
            draw();
            
            // Очищаем предыдущий интервал, если был
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(drop, 500);
            
            // Управление с клавиатуры
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') move(-1);
                else if (e.key === 'ArrowRight') move(1);
                else if (e.key === 'ArrowDown') drop();
                else if (e.key === 'ArrowUp') rotate();
                else if (e.key === ' ') hardDrop();
            });
            
            // Мобильное управление
            document.getElementById('rotate-btn').addEventListener('click', rotate);
            document.getElementById('left-btn').addEventListener('click', () => move(-1));
            document.getElementById('down-btn').addEventListener('click', drop);
            document.getElementById('right-btn').addEventListener('click', () => move(1));
            document.getElementById('hard-drop-btn').addEventListener('click', hardDrop);
        }

        function exitTetris() {
            clearInterval(gameInterval);
            document.getElementById('game-container').style.display = 'none';
            document.body.classList.remove('hidden');
        }
    </script>

</body>
</html>